<script>
	import { invalidate } from '$app/navigation';
	import { tick } from 'svelte';
	import { mode } from 'mode-watcher';
	import '@amap/amap-jsapi-types';
	import { buttonVariants } from '$lib/components/ui/button';
	import * as Drawer from '$lib/components/ui/drawer/index.js';

	let {
		id,
		dialogOpen = $bindable(),
		name,
		address,
		longitude = 116.397861,
		latitude = 39.900401
	} = $props();
	/**	@type {AMap.Map} */
	let map;
	/** @type {AMap.Marker} */
	let marker;
	/** @type {number} */
	let lng = $state(longitude);
	/** @type {number} */
	let lat = $state(latitude);
	/** @type {number} */
	let newLng = $state(longitude);
	/** @type {number} */
	let newLat = $state(latitude);

	async function handleInitMap() {
		// 类似 nextTick 中初始化地图
		// 等待 DOM 更新完成
		await tick();

		try {
			const AMap = await loadAMap();
			initializeMap(AMap);
			setupEventHandlers(AMap);
		} catch (error) {
			console.error(error);
		}
	}

	async function loadAMap() {
		return await window.AMapLoader.load({
			key: import.meta.env.VITE_KEY,
			version: '2.0',
			plugins: ['AMap.Scale']
		});
	}

	/**
	 * @param {AMap} AMap - 参数对象
	 */
	async function initializeMap(AMap) {
		map = new AMap.Map('map', {
			viewMode: '2D',
			zoom: 18,
			center: [lng, lat]
		});

		if ($mode === 'dark') {
			// 设置地图的显示样式
			map.setMapStyle('amap://styles/dark');
		} else {
			map.setMapStyle('amap://styles/normal');
		}

		if (lng && lat) {
			marker = new AMap.Marker({
				position: [lng, lat]
			});
			marker.on('dragend', updatePosition); // 监听拖动结束事件
			map.add(marker);
		}
	}

	/**
	 * @param {AMap} AMap - 参数对象
	 */
	function setupEventHandlers(AMap) {
		// 监听地图点击事件
		map.on('click', function (e) {
			newLng = e.lnglat.getLng();
			newLat = e.lnglat.getLat();

			// 如果 marker 不存在，则创建 marker
			if (!marker) {
				marker = new AMap.Marker({
					position: [newLng, newLat],
					map: map,
					draggable: true // 设置标记可拖拽
				});
				marker.on('dragend', updatePosition); // 监听拖动结束事件
			} else {
				// 如果 marker 已存在，则更新位置
				marker.setPosition([newLng, newLat]);
			}
		});
	}

	function updatePosition() {
		fetch('/hospital', {
			method: 'PATCH',
			body: JSON.stringify({ id, lng: newLng, lat: newLat }),
			headers: {
				'content-type': 'application/json'
			}
		})
			.then(() => {
				invalidate(window.location.pathname);
			})
			.finally(() => {
				dialogOpen = false;
			});
	}

	$effect(() => {
		if (dialogOpen) {
			handleInitMap();
		}
	});
</script>

<Drawer.Root bind:open={dialogOpen} direction="right">
	<Drawer.Content class="md:w-2/3 md:h-full">
		<Drawer.Header class="">
			<Drawer.Title class=""
				>请为医院<span class="text-red-500">{name}</span>选择正确的地址: {address}</Drawer.Title
			>
			<Drawer.Description class="">使用鼠标在地图上选择正确的地址。</Drawer.Description>
		</Drawer.Header>
		<div id="map" class="my-2 h-[calc(100%-100px)] w-full"></div>
		<div class="absolute bottom-20 right-10 rounded bg-slate-400 p-2">
			经度: <span>{lng || 'N/A'}</span>, 纬度: <span>{lat || 'N/A'}</span>
		</div>

		<Drawer.Footer class="">
			<Drawer.Close
				class={buttonVariants({ variant: 'outline' })}
				type="button"
				onclick={updatePosition}
			>
				保存
			</Drawer.Close>
		</Drawer.Footer>
	</Drawer.Content>
</Drawer.Root>
